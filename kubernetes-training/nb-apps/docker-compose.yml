version: '3.8'

services:
  # Services Manager - Port 8080
  services-manager:
    build:
      context: ./services-manager
      dockerfile: Dockerfile
    container_name: nb-services-manager
    ports:
      - "8080:8080"
    environment:
      - APP_NAME=services-manager
      - SECURITY_PIN=drew2
      - LOG_LEVEL=INFO
    volumes:
      - services-data:/app/data
      - ./services-manager/config:/app/config:ro
    networks:
      - nb-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - "com.networkbuster.service=services-manager"
      - "com.networkbuster.version=1.0"

  # Robot Recycling - Port 5000
  robot-recycling:
    build:
      context: ./robot-recycling
      dockerfile: Dockerfile
    container_name: nb-robot-recycling
    ports:
      - "5000:5000"
    environment:
      - FLASK_APP=app.py
      - FLASK_ENV=production
      - SECURITY_PIN=drew2
      - DATABASE_URL=sqlite:///data/robots.db
    volumes:
      - robot-data:/app/data
      - ./robot-recycling/templates:/app/templates:ro
    networks:
      - nb-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - "com.networkbuster.service=robot-recycling"
      - "com.networkbuster.version=1.0"

  # Sudo Manager - Port 8081
  sudo-manager:
    build:
      context: ./sudo-manager
      dockerfile: Dockerfile
    container_name: nb-sudo-manager
    ports:
      - "8081:8081"
    environment:
      - SECURITY_PIN=drew2
      - ADMIN_USER=drew
      - LOG_LEVEL=INFO
    volumes:
      - sudo-logs:/app/logs
      - /etc/sudoers.d:/etc/sudoers.d:ro
    networks:
      - nb-network
    restart: unless-stopped
    privileged: true
    labels:
      - "com.networkbuster.service=sudo-manager"
      - "com.networkbuster.version=1.0"

  # Status Dashboard - Port 8082
  status-dashboard:
    build:
      context: ./status-dashboard
      dockerfile: Dockerfile
    container_name: nb-status-dashboard
    ports:
      - "8082:8082"
    environment:
      - SECURITY_PIN=drew2
      - REFRESH_INTERVAL=5
      - METRIC_RETENTION=7d
    volumes:
      - dashboard-data:/app/data
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - nb-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8082/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - "com.networkbuster.service=status-dashboard"
      - "com.networkbuster.version=1.0"

  # Token Manager - Port 8083
  token-manager:
    build:
      context: ./token-manager
      dockerfile: Dockerfile
    container_name: nb-token-manager
    ports:
      - "8083:8083"
    environment:
      - SECURITY_PIN=drew2
      - TOKEN_EXPIRY=3600
      - ENCRYPTION_KEY=${ENCRYPTION_KEY:-default-key}
    volumes:
      - token-data:/app/data
      - token-secrets:/app/secrets:ro
    networks:
      - nb-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8083/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - "com.networkbuster.service=token-manager"
      - "com.networkbuster.version=1.0"

  # License Manager - Port 8084
  license-manager:
    build:
      context: ./license-manager
      dockerfile: Dockerfile
    container_name: nb-license-manager
    ports:
      - "8084:8084"
    environment:
      - SECURITY_PIN=drew2
      - LICENSE_TYPE=personal
      - OWNER=NetworkBuster
    volumes:
      - license-data:/app/data
      - ./license-manager/licenses:/app/licenses:ro
    networks:
      - nb-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8084/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - "com.networkbuster.service=license-manager"
      - "com.networkbuster.version=1.0"

  # Nginx Reverse Proxy - Port 80
  nginx:
    image: nginx:alpine
    container_name: nb-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - nginx-logs:/var/log/nginx
    networks:
      - nb-network
    restart: unless-stopped
    depends_on:
      - services-manager
      - robot-recycling
      - sudo-manager
      - status-dashboard
      - token-manager
      - license-manager
    labels:
      - "com.networkbuster.service=nginx"
      - "com.networkbuster.version=1.0"

networks:
  nb-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

volumes:
  services-data:
    driver: local
  robot-data:
    driver: local
  sudo-logs:
    driver: local
  dashboard-data:
    driver: local
  token-data:
    driver: local
  token-secrets:
    driver: local
  license-data:
    driver: local
  nginx-logs:
    driver: local
